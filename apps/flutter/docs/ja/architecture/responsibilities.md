# 🏗️ 責務・アーキテクチャルール

## アーキテクチャ概要

このFlutterアプリケーションは、**クリーンアーキテクチャ**を基盤として設計されています。レイヤー間の依存関係を明確に定義し、保守性とテスタビリティを重視した構成となっています。

## レイヤー構成と責務

### 1. 📱 Presentation Layer (プレゼンテーション層)
**場所**: `lib/presentation/`, `lib/*/page/`, `lib/shared/page/`

**責務**:
- ユーザーインターフェースの表示
- ユーザーの入力の受け取り
- アプリケーション層への処理要求

**ルール**:
- ドメイン層に直接依存してはいけない
- ビジネスロジックを含んではいけない
- 状態管理にはRiverpodを使用する

### 2. ⚙️ Application Layer (アプリケーション層)
**場所**: `lib/application/`

**責務**:
- ユースケースの実装
- ドメインオブジェクトの組み合わせ
- プレゼンテーション層とドメイン層の仲介

**ルール**:
- ドメイン層とインフラストラクチャ層に依存可能
- プレゼンテーション層のことは知らない
- トランザクション境界を定義する

### 3. 🎯 Domain Layer (ドメイン層)
**場所**: `lib/domain/`

**責務**:
- ビジネスルールの実装
- ドメインモデルの定義
- リポジトリインターフェースの定義

**ルール**:
- 他の層に依存してはいけない
- Flutterフレームワークに依存してはいけない
- 純粋なDartコードのみ

### 4. 🔧 Infrastructure Layer (インフラストラクチャ層)
**場所**: `lib/infrastracture/`, `lib/shared/api/`

**責務**:
- 外部システムとの連携
- データの永続化
- API通信の実装

**ルール**:
- ドメイン層のインターフェースを実装
- 具体的な技術に依存する実装を含む

## 依存関係のルール

```
Presentation → Application → Domain ← Infrastructure
```

- **上位レイヤーは下位レイヤーに依存可能**
- **下位レイヤーは上位レイヤーに依存してはいけない**
- **Infrastructure層は、Domain層のインターフェースを通じてのみDomain層と連携**

## モジュール間の責務分担

### Core Module (`lib/core/`)
- アプリケーション全体の設定と初期化
- ルーティング定義
- 定数定義

### Shared Module (`lib/shared/`)
- 複数のドメインで使用される共通コンポーネント
- API通信基盤
- 状態管理基盤
- テーマシステム

### Domain-specific Modules (`lib/family/`, `lib/member/`, `lib/quest/`)
- 各ドメインに特化した機能
- そのドメインに関連するページ、API、サービス

## 状態管理の責務

### Riverpod Provider の種類と用途
- **StateProvider**: 単純な値の状態管理
- **StateNotifierProvider**: 複雑な状態の管理
- **FutureProvider**: 非同期処理の結果
- **StreamProvider**: リアルタイムデータの監視

### 状態の配置ルール
- **グローバル状態**: `lib/shared/state/`
- **ドメイン固有状態**: 各ドメインディレクトリ内

## エラーハンドリング

### エラーの分類
1. **ドメインエラー**: ビジネスルール違反
2. **アプリケーションエラー**: ユースケース実行時のエラー
3. **インフラストラクチャエラー**: 外部システム連携エラー

### エラー処理の責務
- **Domain Layer**: ドメインエラーの定義と検証
- **Application Layer**: エラーのキャッチとハンドリング
- **Presentation Layer**: ユーザーへのエラー表示

## テストの責務

### 各層のテスト方針
- **Domain Layer**: 単体テスト中心、ビジネスロジックを検証
- **Application Layer**: ユースケーステスト、モックを活用
- **Presentation Layer**: ウィジェットテスト、ユーザーインタラクションを検証
- **Infrastructure Layer**: 統合テスト、外部システムとの連携を検証

## パフォーマンスの考慮事項

### Widget最適化
- 不要な再描画を避けるためのウィジェット分割
- `const` コンストラクターの活用
- Riverpodの適切な使用によるマイクロリビルド

### メモリ管理
- StreamやListenerの適切な破棄
- 大きなオブジェクトのライフサイクル管理