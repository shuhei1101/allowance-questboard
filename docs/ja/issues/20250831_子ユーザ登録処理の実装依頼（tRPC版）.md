# 子ユーザ登録処理の実装依頼（tRPC版）

## 概要
親ユーザが入力した子供のメールアドレスを元に招待レコードを作成し、子供がリンク経由でパスワードを設定してサインアップできるフローを実装する。

バックエンドは Node.js + TypeORM + tRPC、認証は Supabase を使用。  
AIには「招待トークン生成、DB保存、検証、子ユーザ作成までの一連の処理」を tRPC ルーターで実装してほしい。

---

## フロー

1. **親ユーザが子供登録画面でメールアドレスを入力**
   - サーバーで招待トークンを生成
   - `FamilyInvite` テーブルに保存
   - 有効期限は24時間、`used=false`

2. **招待メール送信**
   - トークン付きリンクを子供のメールに送信
   - 例: `https://myapp.com/invite?token=xxxx`

3. **子供がリンクを開く**
   - アプリでパスワード入力画面を表示

4. **子供がサインアップ**
   - フロントから `token + email + password` を tRPC 経由で送信
   - サーバーで招待トークン検証
     - トークン存在確認
     - 有効期限内か
     - 未使用か
     - メール一致か

5. **ユーザ作成**
   - Supabase Admin API を使ってユーザ作成
   - 成功したら `FamilyInvite.used = true` に更新
   - 作成したユーザIDを `familyId` と紐付け

6. **完了**
   - 子供はログイン可能
   - 招待トークンは失効済み

---

## 招待テーブル要件 (`FamilyInvite`)

- テーブル名: `FamilyInvites`
- エンティティ名: `FamilyInviteEntity`
- 配置場所: `src/features/family/entity/FamilyInviteEntity.ts`
- 継承元: `BaseTransactionEntity`

- `familyId` (number, 招待元の家族ID) // 参照先: `FamilyEntity`
- `email` (TEXT, 招待対象メール)
- `token` (TEXT, 招待トークン, ランダム64文字以上)
- `expiresAt` (TIMESTAMPTZ, 有効期限)
- `isUsed` (BOOLEAN, デフォルト false)

---

## tRPC API インターフェース例

### 親側（招待作成）
```ts
export const createFamilyInviteInput = z.object({
  familyId: FamilyIdSchema,
  email: EmailSchema,
});


// router/familyInvite.ts
createInvite: t.procedure
  .input(createFamilyInviteInput)
  .mutation(async ({ input }) => {
    // 招待作成 + DB保存 + メール送信
  });

## 作成計画

### 共通値オブジェクト・スキーマ
- [x] Email (value-object)
  - 作成場所: `@backend/features/auth/value-object/email.ts` (既存確認)
  - 概要: メールアドレスバリデーション付きZodスキーマ
- [x] FamilyId (value-object)
  - 作成場所: `@backend/features/family/value-object/familyId.ts` (既存確認)
  - 概要: 家族ID値オブジェクト・Zodスキーマ
- [x] InviteToken (value-object)
  - 作成場所: `@backend/features/family/value-object/inviteToken.ts`
  - 概要: 招待トークン値オブジェクト・Zodスキーマ（ランダム生成機能付き）

### バックエンド (招待機能)
- [x] FamilyInviteEntity
  - 作成場所: `@backend/src/features/family/entity/familyInviteEntity.ts`
  - 概要: 招待テーブルエンティティ、BaseTransactionEntity継承（インデックス）
- [x] FamilyInviteDao
  - 作成場所: `@backend/src/features/family/dao/familyInviteDao.ts`
  - 概要: 招待データアクセス、トークン検索・更新機能
- [x] FamilyInvite (ドメインモデル)
  - 作成場所: `@backend/src/features/family/models/familyInvite.ts`
  - 概要: 招待ドメインモデル、BaseDomainModel継承
- [x] FamilyInviteRepository
  - 作成場所: `@backend/src/features/family/repository/familyInviteRepository.ts`
  - 概要: 招待データアクセスリポジトリ
- [ ] createFamilyInvite
  - 作成場所: `@backend/src/features/family/services/createFamilyInvite.ts`
  - 概要: 招待レコード作成ビジネスロジック
- [ ] verifyInviteToken
  - 作成場所: `@backend/src/features/family/services/verifyInviteToken.ts`
  - 概要: 招待トークン検証ビジネスロジック
- [ ] familyInviteRouter
  - 作成場所: `@backend/src/features/family/router/familyInviteRouter.ts`
  - 概要: 招待関連tRPCエンドポイント (createInvite, acceptInvite)

### バックエンド (Supabase Admin連携)
- [ ] SupabaseAdminClient
  - 作成場所: `@backend/src/core/supabase/supabaseAdminClient.ts`
  - 概要: Supabase Admin API クライアント、ユーザ作成機能
- [ ] createChildUser
  - 作成場所: `@backend/src/features/child/services/createChildUser.ts`
  - 概要: 子ユーザ作成（Supabase + DB連携）

### フロントエンド (招待機能)
- [ ] inviteFamily
  - 作成場所: `@frontend/src/features/family/services/inviteFamily.ts`
  - 概要: 親ユーザが子供を招待するAPI呼び出し
- [ ] acceptInvite
  - 作成場所: `@frontend/src/features/family/services/acceptInvite.ts`
  - 概要: 子供が招待を受諾するAPI呼び出し
- [ ] InviteForm (value-object/model)
  - 作成場所: `@frontend/src/features/family/models/inviteForm.ts`
  - 概要: 招待フォームバリデーション付きモデル
- [ ] AcceptInviteForm (value-object/model)
  - 作成場所: `@frontend/src/features/family/models/acceptInviteForm.ts`
  - 概要: 招待受諾フォームバリデーション付きモデル

### フロントエンド (UI画面)
- [ ] ChildInvitePage
  - 作成場所: `@frontend/src/features/family/child-invite-page/ChildInvitePage.tsx`
  - 概要: 親が子供にメール招待を送る画面
- [ ] AcceptInvitePage
  - 作成場所: `@frontend/src/features/family/accept-invite-page/AcceptInvitePage.tsx`
  - 概要: 子供が招待リンクからパスワード設定する画面

### 設定・ルーター更新
- [ ] main router更新
  - 更新場所: `@backend/src/router.ts`
  - 概要: familyInviteRouter を appRouter に追加
- [ ] 環境変数設定
  - 更新場所: `@backend/.env`
  - 概要: SUPABASE_SERVICE_ROLE_KEY 等の管理者権限キー追加

### テスト
- [ ] FamilyInviteDao テスト
- [ ] createFamilyInviteUseCase テスト  
- [ ] verifyInviteTokenUseCase テスト
- [ ] familyInviteRouter テスト
