# 子ユーザ登録処理の実装依頼（tRPC版）

## 概要
子供が自身でアカウント作成を行い、親が発行した家族招待コードを入力して家族に参加できるフローを実装する。

バックエンドは Node.js + TypeORM + tRPC、認証は Supabase を使用。  
AIには「家族招待コード生成、DB保存、検証、家族参加までの一連の処理」を tRPC ルーターで実装してほしい。

---

## フロー

1. **子供が自身でアカウント作成**
   - 子供が通常のサインアップフロー（メール + パスワード）でアカウント作成
   - Supabase Auth でユーザ作成
   - ChildEntity をDBに作成

2. **親が家族招待コードを発行**
   - 親ユーザが家族招待コード発行画面を開く
   - サーバーで短い招待コード（6桁〜8桁）を生成
   - `FamilyInvite` テーブルに保存
   - 有効期限は7日間、`used=false`
   - 親に招待コードを表示（コピー可能）

3. **子供が招待コードを入力**
   - 子供がアプリで「家族に参加」画面を開く
   - 招待コード入力フォームを表示

4. **子供が家族に参加**
   - フロントから `inviteCode + childUserId` を tRPC 経由で送信
   - サーバーで招待コード検証
     - コード存在確認
     - 有効期限内か
     - 未使用か
     - 既に家族に参加していないか

5. **家族関連付け**
   - 検証成功したら `FamilyInvite.used = true` に更新
   - 子供のChildEntityに `familyId` を設定
   - FamilyMemberEntity を作成して家族メンバーとして登録

6. **完了**
   - 子供は家族の一員として機能利用可能
   - 招待コードは失効済み

---

## 招待テーブル要件 (`FamilyInvite`)

- テーブル名: `FamilyInvites`
- エンティティ名: `FamilyInviteEntity`
- 配置場所: `src/features/family/entity/FamilyInviteEntity.ts`
- 継承元: `BaseTransactionEntity`

- `familyId` (number, 招待元の家族ID) // 参照先: `FamilyEntity`
- `inviteCode` (TEXT, 招待コード, 6〜8桁の英数字)
- `expiresAt` (TIMESTAMPTZ, 有効期限)
- `isUsed` (BOOLEAN, デフォルト false)

---

## tRPC API インターフェース例

### 親側（招待コード生成）
```ts
export const createFamilyInviteInput = z.object({
  familyId: FamilyIdSchema,
});

// router/familyInvite.ts
createInviteCode: t.procedure
  .input(createFamilyInviteInput)
  .mutation(async ({ input }) => {
    // 招待コード生成 + DB保存
    return { inviteCode: string }
  });
```

### 子供側（招待コード検証・家族参加）
```ts
export const joinFamilyWithCodeInput = z.object({
  inviteCode: InviteCodeSchema,
  childUserId: z.string(), // Supabase Auth User ID
});

// router/familyInvite.ts
joinFamilyWithCode: t.procedure
  .input(joinFamilyWithCodeInput)
  .mutation(async ({ input }) => {
    // 招待コード検証 + 家族参加処理
  });
```

## 作成計画

### 共通値オブジェクト・スキーマ
- [x] FamilyId (value-object)
  - 作成場所: `@backend/features/family/value-object/familyId.ts` (既存確認)
  - 概要: 家族ID値オブジェクト・Zodスキーマ
- [ ] InviteCode (value-object)
  - 作成場所: `@backend/features/family/value-object/inviteCode.ts`
  - 概要: 招待コード値オブジェクト・Zodスキーマ（6〜8桁英数字生成機能付き）

### バックエンド (招待機能)
- [ ] FamilyInviteEntity
  - 更新場所: `@backend/src/features/family/entity/familyInviteEntity.ts`
  - 概要: 招待テーブルエンティティ更新（email削除、inviteCode追加）
- [ ] FamilyInviteDao
  - 更新場所: `@backend/src/features/family/dao/familyInviteDao.ts`
  - 概要: 招待データアクセス更新（コード検索機能）
- [ ] FamilyInvite (ドメインモデル)
  - 更新場所: `@backend/src/features/family/models/familyInvite.ts`
  - 概要: 招待ドメインモデル更新（email削除、inviteCode追加）
- [ ] FamilyInviteRepository
  - 更新場所: `@backend/src/features/family/repository/familyInviteRepository.ts`
  - 概要: 招待データアクセスリポジトリ更新
- [ ] createFamilyInviteCode
  - 作成場所: `@backend/src/features/family/services/createFamilyInviteCode.ts`
  - 概要: 招待コード生成ビジネスロジック
- [ ] joinFamilyWithCode
  - 作成場所: `@backend/src/features/family/services/joinFamilyWithCode.ts`
  - 概要: 招待コード検証・家族参加ビジネスロジック
- [ ] familyInviteRouter
  - 作成場所: `@backend/src/features/family/router/familyInviteRouter.ts`
  - 概要: 招待関連tRPCエンドポイント (createInviteCode, joinFamilyWithCode)

### フロントエンド (招待機能)
- [ ] createInviteCode
  - 作成場所: `@frontend/src/features/family/services/createInviteCode.ts`
  - 概要: 親ユーザが招待コードを生成するAPI呼び出し
- [ ] joinFamilyWithCode
  - 作成場所: `@frontend/src/features/family/services/joinFamilyWithCode.ts`
  - 概要: 子供が招待コードで家族参加するAPI呼び出し
- [ ] InviteCodeForm (value-object/model)
  - 作成場所: `@frontend/src/features/family/models/inviteCodeForm.ts`
  - 概要: 招待コード入力フォームバリデーション付きモデル

### フロントエンド (UI画面)
- [ ] CreateInviteCodePage
  - 作成場所: `@frontend/src/features/family/create-invite-code-page/CreateInviteCodePage.tsx`
  - 概要: 親が家族招待コードを生成・表示する画面
- [ ] JoinFamilyPage
  - 作成場所: `@frontend/src/features/family/join-family-page/JoinFamilyPage.tsx`
  - 概要: 子供が招待コードを入力して家族に参加する画面

### 設定・ルーター更新
- [ ] main router更新
  - 更新場所: `@backend/src/router.ts`
  - 概要: familyInviteRouter を appRouter に追加

### テスト
- [ ] FamilyInviteDao テスト
- [ ] createFamilyInviteCode テスト  
- [ ] joinFamilyWithCode テスト
- [ ] familyInviteRouter テスト
