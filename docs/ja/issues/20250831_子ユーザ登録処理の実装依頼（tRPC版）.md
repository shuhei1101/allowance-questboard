# 子ユーザ登録処理の実装依頼（tRPC版）

## 概要
親ユーザが入力した子供のメールアドレスを元に招待レコードを作成し、子供がリンク経由でパスワードを設定してサインアップできるフローを実装する。

バックエンドは Node.js + TypeORM + tRPC、認証は Supabase を使用。  
AIには「招待トークン生成、DB保存、検証、子ユーザ作成までの一連の処理」を tRPC ルーターで実装してほしい。

---

## フロー

1. **親ユーザが子供登録画面でメールアドレスを入力**
   - サーバーで招待トークンを生成
   - `FamilyInvite` テーブルに保存
   - 有効期限は24時間、`used=false`

2. **招待メール送信**
   - トークン付きリンクを子供のメールに送信
   - 例: `https://myapp.com/invite?token=xxxx`

3. **子供がリンクを開く**
   - アプリでパスワード入力画面を表示

4. **子供がサインアップ**
   - フロントから `token + email + password` を tRPC 経由で送信
   - サーバーで招待トークン検証
     - トークン存在確認
     - 有効期限内か
     - 未使用か
     - メール一致か

5. **ユーザ作成**
   - Supabase Admin API を使ってユーザ作成
   - 成功したら `FamilyInvite.used = true` に更新
   - 作成したユーザIDを `familyId` と紐付け

6. **完了**
   - 子供はログイン可能
   - 招待トークンは失効済み

---

## 招待テーブル要件 (`FamilyInvite`)

- テーブル名: `FamilyInvites`
- エンティティ名: `FamilyInviteEntity`
- 配置場所: `src/features/family/entity/FamilyInviteEntity.ts`
- 継承元: `BaseTransactionEntity`

- `familyId` (number, 招待元の家族ID) // 参照先: `FamilyEntity`
- `email` (TEXT, 招待対象メール)
- `token` (TEXT, 招待トークン, ランダム64文字以上)
- `expiresAt` (TIMESTAMPTZ, 有効期限)
- `isUsed` (BOOLEAN, デフォルト false)

---

## tRPC API インターフェース例

### 親側（招待作成）
```ts
export const createFamilyInviteInput = z.object({
  familyId: FamilyIdSchema,
  email: EmailSchema,
});


// router/familyInvite.ts
createInvite: t.procedure
  .input(createFamilyInviteInput)
  .mutation(async ({ input }) => {
    // 招待作成 + DB保存 + メール送信
  });
