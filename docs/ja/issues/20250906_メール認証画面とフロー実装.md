# メール認証画面とフロー実装

## 概要
新規登録後のメール認証フローを実装し、ユーザーがメール内リンクをクリックしてアプリに戻った際に自動的に認証状態をチェックし、認証完了時は自動ログイン→ホーム画面遷移を行う機能を実装する。

## 要件
- 新規登録成功後、メール認証待ち画面（EmailVerifyPage.tsx）に遷移
- アプリがフォアグラウンドに戻った際に認証状態を自動チェック
- 認証完了時は自動ログイン処理を実行してホーム画面へ遷移
- メール認証リンクからのDeep Link対応
- 再送機能の実装

## 画面レイアウトイメージ
```plaintext
┌─────────────────────────────────────┐
│ ← [戻る]         メール認証          │ ← ヘッダーエリア
├─────────────────────────────────────┤
│                                     │
│                                     │
│              📧                     │ ← メインコンテンツエリア（上部）
│         [メールアイコン]              │   アイコン：大きく、中央配置
│                                     │   アニメーション効果あり
│                                     │
│                                     │
│     確認メールを送信しました。         │ ← メインコンテンツエリア（中央）
│   メール内のリンクをクリックして       │   説明テキスト：分かりやすく
│     登録を完了してください。           │   
│                                     │
│        📩 user@example.com          │   メールアドレス：ハイライト表示
│                                     │   
│         ⏳ 認証を確認中...            │   ステータス：リアルタイム更新
│                                     │   
│                                     │
│                                     │
│      [確認メールを再送する]            │ ← アクションエリア（下部）
│         (60秒後に利用可能)            │   再送ボタン：クールダウン表示
│                                     │   
│                                     │
│                                     │
│     ❓ メールが届かない場合は？        │ ← ヘルプエリア（最下部）
│         [詳細を見る ▼]              │   ヘルプ：折りたたみ式
│                                     │   
│     (展開時)                        │   
│     ・スパムフォルダを確認            │   
│     ・メール設定を確認               │   
│     ・サポートに連絡                 │   
│                                     │
└─────────────────────────────────────┘

【状態変化パターン】

1. 初期状態：
   ⏳ 認証を確認中... → メール認証待ち

2. アプリ復帰時：
   🔄 認証状態を確認しています... → チェック実行中

3. 認証完了時：
   ✅ 認証完了！自動ログインしています... → 自動遷移

4. 再送成功時：
   📤 確認メールを再送しました → 一時表示

5. エラー時：
   ❌ エラーが発生しました → エラー表示
```

## 実装タスク

### 1. フロントエンド（値オブジェクト・基底クラス）
- [x] 完了済み

### 2. フロントエンド（サービス層）
- [x] メール認証状態チェックサービス
  - ファイルパス: `packages/frontend/src/features/auth/email-verify-page/services/checkEmailVerifyStatus.ts`
  - 概要:
    - Supabaseから認証状態取得
    - email_confirmed_at確認処理
    - セッション状態の確認
  - 参考: `packages/frontend/src/features/auth/login-page/services/login.ts`

- [x] 確認メール再送サービス
  - ファイルパス: `packages/frontend/src/features/auth/email-verify-page/services/resendVerificationEmail.ts`
  - 概要:
    - Supabaseでメール再送処理
    - メール送信API呼び出し
    - エラーハンドリング
  - 参考: `packages/frontend/src/features/auth/register-user-page/services/userRegister.ts`

- [x] 自動ログインサービス
  - ファイルパス: `packages/frontend/src/features/auth/email-verify-page/services/autoLogin.ts`
  - 概要:
    - 認証完了ユーザーの自動ログイン処理
    - セッション確立処理
    - ユーザー情報取得処理
  - 参考: `packages/frontend/src/features/auth/login-page/services/login.ts`

### 3. フロントエンド（状態管理）
- [x] EmailVerifyPage用の状態管理
  - ファイルパス: `packages/frontend/src/features/auth/email-verify-page/stores/emailVerifyPageStore.ts`
  - 概要:
    - ページレベルの状態管理（ローディング状態など）
    - 登録時のメールアドレス保持
    - 認証チェック関連の状態管理
  - 参考: `packages/frontend/src/features/auth/register-user-page/stores/userRegisterPageStore.ts`
  - Enum定義:
    - `EmailVerifyStatus`: 認証状態の列挙型
      - `WAITING`: メール認証待ち（初期状態）
      - `CHECKING`: 認証状態確認中（AppState復帰時など）
      - `VERIFIED`: 認証完了（自動ログイン開始）
      - `FAILED`: 認証失敗（エラー状態）
  - プロパティ:
    - `email`: 登録時のメールアドレス（`Email`型）
    - `isLoading`: 全体のローディング状態
    - `isCheckingAuth`: 認証状態チェック中
    - `isResending`: メール再送中
    - `isAutoLoginInProgress`: 自動ログイン処理中
    - `emailVerifyStatus`: 認証状態（EmailVerifyStatus型）
    - `resendCooldown`: 再送までの残り秒数
    - `resendCount`: 本日の再送回数
    - `maxResendCount`: 1日の最大再送回数
    - `lastResendTime`: 最後の再送時刻
    - `isHelpSectionExpanded`: ヘルプセクションの展開状態
    - `errorMessage`: エラーメッセージ
  - アクション:
    - `setEmail`: メールアドレス設定
    - `setLoading`: ローディング状態設定
    - `setCheckingAuth`: 認証チェック状態設定
    - `setEmailVerifyStatus`: 認証状態設定
    - `setAutoLoginInProgress`: 自動ログイン状態設定
    - `setResending`: 再送状態設定
    - `setResendCooldown`: 再送クールダウン設定
    - `incrementResendCount`: 再送回数増加
    - `updateLastResendTime`: 最後の再送時刻更新
    - `resetResendState`: 再送状態リセット
    - `toggleHelpSection`: ヘルプセクション開閉
    - `setError`: エラー設定
    - `clearError`: エラークリア
    - `canResend`: 再送可能判定
    - `canAutoLogin`: 自動ログイン可能判定
    - `shouldCheckVerification`: 認証チェック要否判定

### 4. フロントエンド（フック層）
- [x] メール認証チェックハンドラー
  - ファイルパス: `packages/frontend/src/features/auth/email-verify-page/hooks/useEmailVerificationChecker.ts`
  - 概要:
    - AppState監視のイベントハンドラー
    - 認証状態チェックの実行制御
    - 認証完了時のコールバック処理
  - 参考: `packages/frontend/src/features/auth/register-user-page/hooks/useUserRegisterHandler.ts`

- [x] 確認メール再送ハンドラー
  - ファイルパス: `packages/frontend/src/features/auth/email-verify-page/hooks/useResendEmailHandler.ts`
  - 概要:
    - 再送ボタンクリック時のイベントハンドラー
    - クールダウン制御処理
    - 再送回数制限処理
  - 参考: `packages/frontend/src/features/auth/register-user-page/hooks/useUserRegisterHandler.ts`

- [x] 自動ログインハンドラー
  - ファイルパス: `packages/frontend/src/features/auth/email-verify-page/hooks/useAutoLoginHandler.ts`
  - 概要:
    - 認証完了時の自動ログインイベントハンドラー
    - ホーム画面への遷移制御
    - エラー時の処理制御
  - 参考: `packages/frontend/src/features/auth/login-page/hooks/useLoginHandler.ts`

### 5. フロントエンド（UIコンポーネント）

#### ヘッダーエリア
- [x] 戻るボタンコンポーネント
  - ファイルパス: expo標準の戻るボタン使用
  - 概要: ログイン画面に戻る

#### メインコンテンツエリア（上部）
- [x] メールアイコン表示コンポーネント
  - ファイルパス: `packages/frontend/src/features/auth/email-verify-page/components/EmailIcon.tsx`
  - 概要:
    - 大きなメールアイコンを中央表示
    - アニメーション効果付き（オプション）
  - 参考: 既存のアイコンコンポーネント

#### メインコンテンツエリア（中央）
- [x] メール認証説明テキストコンポーネント
  - ファイルパス: `packages/frontend/src/features/auth/email-verify-page/components/DescriptionText.tsx`
  - 概要:
    - 「確認メールを送信しました」等の説明テキスト
    - 多言語対応
    - 段階的な説明表示
  - 参考: 既存のテキストコンポーネント

- [x] 送信先メールアドレス表示コンポーネント
  - ファイルパス: `packages/frontend/src/features/auth/email-verify-page/components/EmailView.tsx`
  - 概要:
    - 登録したメールアドレスをハイライト表示
    - 一部マスク表示機能（セキュリティ考慮）
  - 参考: 既存の入力フィールドコンポーネント

- [x] 認証ステータス表示コンポーネント
  - ファイルパス: `packages/frontend/src/features/auth/email-verify-page/components/Indicator.tsx`
  - 概要:
    - 認証チェック中のローディング表示
    - 認証完了時のチェックマーク表示
    - ステータス変化のアニメーション
  - 参考: 既存のローディングコンポーネント

#### アクションエリア（下部）
- [x] 確認メール再送ボタンコンポーネント
  - ファイルパス: `packages/frontend/src/features/auth/email-verify-page/components/ResendEmailButton.tsx`
  - 概要:
    - 再送ボタン（クールダウン機能付き）
    - ローディング状態表示
    - 再送回数制限機能
  - 参考: `packages/frontend/src/features/shared/components/HeaderButton.tsx`

#### ヘルプエリア（最下部）
- [x] ヘルプ・トラブルシュート表示コンポーネント
  - ファイルパス: `packages/frontend/src/features/auth/email-verify-page/components/HelpSection.tsx`
  - 概要:
    - 「メールが届かない場合は？」等のヘルプ情報
    - 折りたたみ式表示
    - スパムフォルダ確認等のアドバイス表示
  - 参考: 既存のヘルプコンポーネント

### 6. フロントエンド（ページハンドラー統合）
- [x] ページレベルハンドラー統合
  - ファイルパス: `packages/frontend/src/features/auth/email-verify-page/hooks/createPageHandlers.ts`
  - 概要:
    - 全ハンドラーの依存性注入と統合管理
    - ページコンポーネント用の統一インターフェース提供
    - サービス層とストアの連携制御
    - AppStateイベント管理とライフサイクル制御
  - 参考: `packages/frontend/src/features/auth/login-page/hooks/useLoginHandler.ts`

### 7. フロントエンド（画面）
- [ ] EmailVerifyPage画面コンポーネント
  - ファイルパス: `packages/frontend/src/features/auth/email-verify-page/EmailVerifyPage.tsx`
  - 概要: 
    - メール認証待ち画面のメインコンポーネント
    - ページハンドラーを使用したクリーンなアーキテクチャ
    - UIコンポーネントの組み合わせと配置
  - 参考: `packages/frontend/src/features/auth/register-user-page/UserRegisterPage.tsx`

### 8. フロントエンド（ナビゲーション）
- [ ] ナビゲーション設定の更新
  - ファイルパス: `packages/frontend/AppNavigator.tsx`
  - 概要:
    - EmailVerifyPageをナビゲーションスタックに追加
    - Deep Link用のルーティング設定
  - 参考: 既存のナビゲーション設定

### 9. フロントエンド（Deep Link）
- [ ] Deep Link処理の実装
  - ファイルパス: `packages/frontend/src/core/deeplink/emailVerificationDeepLink.ts`
  - 概要:
    - メール認証リンクからのDeep Link処理
    - URLパラメータ解析
    - 適切な画面への遷移処理
  - 参考: 既存のDeep Link処理（もしあれば）

### 10. フロントエンド（設定）
- [ ] Expo設定の更新
  - ファイルパス: `packages/frontend/app.json`
  - 概要:
    - Deep Link用のスキーム設定
    - Intent Filter設定（Android）
    - URL Scheme設定
  - 参考: Expo Deep Link公式ドキュメント

### 11. バックエンド（設定）
- [ ] Supabase認証設定の更新
  - ファイルパス: Supabaseダッシュボード設定
  - 概要:
    - Redirect URLの追加
    - メール認証有効化設定の確認
    - Deep Link用URLの登録

### 12. フロントエンド（メッセージ）
- [ ] メール認証関連メッセージの追加
  - ファイルパス: `packages/backend/src/core/messages/authErrorMessages.ts`
  - 概要:
    - メール認証待ち画面用のメッセージ
    - 再送完了メッセージ
    - 認証完了メッセージ
  - 参考: 既存のAuthErrorMessages

### 13. フロントエンド（フロー修正）
- [ ] 新規登録成功時の遷移先変更
  - ファイルパス: `packages/frontend/src/features/auth/register-user-page/hooks/useUserRegisterHandler.ts`
  - 概要:
    - 新規登録成功時にEmailVerifyPageへ遷移
    - 登録したメールアドレスをパラメータで渡す
  - 参考: 現在の実装

### 14. テスト
- [ ] サービス層のテスト
  - ファイルパス: `packages/frontend/__tests__/features/auth/email-verify-page/services/`
  - 概要:
    - checkEmailVerificationStatusのテスト
    - resendVerificationEmailのテスト
    - performAutoLoginのテスト

- [ ] フック層のテスト
  - ファイルパス: `packages/frontend/__tests__/features/auth/email-verify-page/hooks/`
  - 概要:
    - useEmailVerificationCheckerのテスト
    - useResendEmailHandlerのテスト
    - useAutoLoginHandlerのテスト
    - createPageHandlersのテスト

## メール認証処理フロー

### メインフロー（正常パターン）
```plaintext
[ユーザー登録完了] 
        │
        ▼
  [EmailVerifyPage遷移]
        │
        ├─ 📧 メール送信確認表示
        ├─ ⏳ AppState監視開始
        └─ 🔄 定期的認証チェック開始
        │
        ▼
   [ユーザー行動]
        │
        ├─── [メールアプリでリンクタップ] ──┐
        │                                │
        ├─── [アプリをバックグラウンド] ────┤
        │                                │
        └─── [再送ボタンタップ] ──────────┐│
                                        ││
        ┌───────────────────────────────┘│
        ▼                                │
   [Deep Link起動]                      │
        │                                │
        ├─ URLパラメータ解析              │
        ├─ 認証トークン取得               │
        └─ EmailVerifyPageに遷移         │
        │                                │
        ┌────────────────────────────────┘
        ▼
   [認証状態チェック]
        │
        ├─ Supabase.auth.getSession()
        ├─ email_confirmed_at確認
        └─ EmailVerifyStatus更新
        │
        ▼
    ┌─[認証完了？]─┐
    │              │
   YES            NO
    │              │
    ▼              ▼
[自動ログイン]   [認証待ち継続]
    │              │
    ├─セッション確立 ├─ 再チェック待機
    ├─ユーザー情報取得├─ AppState監視継続
    └─ホーム画面遷移  └─ タイムアウト処理
```

### Deep Linkフロー詳細
```plaintext
[メール内リンクタップ]
        │
        ▼
   [OS判定処理]
        │
        ├─ iOS: Custom URL Scheme
        └─ Android: Intent Filter
        │
        ▼
   [アプリ起動判定]
        │
    ┌──[アプリ状態？]──┐
    │                  │
 起動中             未起動
    │                  │
    ▼                  ▼
[Foreground遷移]   [Cold Start]
    │                  │
    ├─ Navigation      ├─ App初期化
    └─ Parameter受取   ├─ Navigation Setup
                      └─ Parameter受取
    │
    ┌─────────────────┘
    ▼
[Deep Link Parameter処理]
        │
        ├─ token: 認証トークン
        ├─ type: email（認証タイプ）
        ├─ redirect_to: 遷移先URL
        └─ error: エラー情報
        │
        ▼
   [EmailVerifyPage表示]
        │
        └─ 認証状態チェック実行
```

### AppState監視フロー
```plaintext
[AppState.addEventListener登録]
        │
        ▼
    [State変化検知]
        │
    ┌──[AppState？]──┐
    │                │
 active           background/inactive
    │                │
    ▼                ▼
[認証チェック実行]  [監視継続]
    │                │
    ├─ 前回チェックから │
    │  5秒以上経過？    │
    │                 │
   YES               NO
    │                │
    ▼                ▼
[Supabase確認]    [Skip]
    │
    ▼
[認証状態更新]
```

### エラーハンドリングフロー
```plaintext
[各処理でエラー発生]
        │
        ├─ ネットワークエラー
        ├─ 認証トークン無効
        ├─ セッション作成失敗
        └─ タイムアウト
        │
        ▼
   [エラー種別判定]
        │
        ├─ 一時的エラー → 再試行可能表示
        ├─ 認証エラー → メール再送促進
        ├─ ネットワークエラー → 接続確認促進
        └─ その他 → サポート連絡促進
        │
        ▼
    [エラー状態表示]
        │
        ├─ ❌ エラーメッセージ
        ├─ 🔄 再試行ボタン
        └─ 💬 ヘルプセクション展開
```

### 再送機能フロー
```plaintext
[再送ボタンタップ]
        │
        ▼
   [再送可能性チェック]
        │
        ├─ クールダウン時間確認（60秒）
        ├─ 1日の再送回数確認（最大5回）
        └─ ネットワーク状態確認
        │
        ▼
    ┌─[再送可能？]─┐
    │               │
   YES             NO
    │               │
    ▼               ▼
[メール再送実行]  [エラー表示]
    │               │
    ├─Supabase呼出  ├─「しばらく待って」
    ├─Loading表示   ├─「上限到達」
    └─成功/失敗判定 └─「接続確認して」
        │
        ▼
    ┌─[再送結果？]─┐
    │               │
   成功            失敗
    │               │
    ▼               ▼
[成功メッセージ]  [エラーメッセージ]
    │               │
    ├─📤「再送完了」 ├─❌「再送失敗」
    ├─クールダウン開始├─再試行ボタン表示
    └─再送回数増加   └─ヘルプ表示促進
```

### タイムアウト・自動処理フロー
```plaintext
[EmailVerifyPage表示開始]
        │
        ├─ ⏰ 15分タイマー開始
        └─ 🔄 30秒間隔チェック開始
        │
        ▼
    [定期チェック実行]
        │
        ├─ 残り時間確認
        ├─ 認証状態チェック
        └─ UI状態更新
        │
        ▼
    ┌─[状況判定？]─┐
    │               │
  認証完了        タイムアウト
    │               │
    ▼               ▼
[自動ログイン]    [タイムアウト処理]
    │               │
    └─ホーム画面     ├─⏰「時間切れ」表示
                   ├─🔄 再送促進メッセージ
                   └─📞 サポート連絡案内
```

## 注意事項
- Deep Linkのテストは実機で行うこと
- AppStateの変化検知はiOSとAndroidで動作が異なる場合があるため、両方でテストすること
- Supabaseのメール認証設定が正しく行われていることを確認してから実装すること
- ユーザー体験を考慮し、適切なローディング表示やエラーメッセージを実装すること

## 関連ドキュメント
- [Expo Deep Linking](https://docs.expo.dev/guides/deep-linking/)
- [Supabase Auth](https://supabase.com/docs/guides/auth)
- [React Native AppState](https://reactnative.dev/docs/appstate)
