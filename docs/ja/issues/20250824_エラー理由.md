# ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼èª¿æŸ»çµæœ

## ã‚¨ãƒ©ãƒ¼æ¦‚è¦ï¼ˆè§£æ±ºæ¸ˆã¿âœ…ï¼‰
```
ERROR  Cannot read property 'hash' of undefined
```
**ç™ºç”Ÿå ´æ‰€**: BaseCollection.ts ã® get()ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆ74è¡Œç›®ï¼‰

## èª¿æŸ»çµæœãƒ»ä¿®æ­£å®Œäº†

### ğŸ” **æœ€çµ‚çš„ãªã‚¨ãƒ©ãƒ¼è©³ç´°æƒ…å ±**
```
TypeError: Cannot read property 'hash' of undefined
BaseCollection#get (../backend/src/core/models/baseCollection.ts:74:26)
```

### âœ… **ä¿®æ­£ç®‡æ‰€**
**ãƒ•ã‚¡ã‚¤ãƒ«**: `packages/backend/src/core/models/baseCollection.ts`

1. **updateIndex()ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆ52è¡Œç›®å‘¨è¾ºï¼‰**
   ```typescript
   // ä¿®æ­£å‰
   const key = item.key.hash().toString();
   this.itemByIds.set(key, item);
   
   // ä¿®æ­£å¾Œ
   if (item.key) {
     const hashValue = item.key.hash();
     if (hashValue !== undefined && hashValue !== null) {
       const key = hashValue.toString();
       this.itemByIds.set(key, item);
     }
   }
   ```

2. **get()ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆ73è¡Œç›®ï¼‰**
   ```typescript
   // ä¿®æ­£å‰
   get(itemId: TKey): TItem | null {
     const key = itemId.hash().toString();
     return this.itemByIds.get(key) || null;
   }
   
   // ä¿®æ­£å¾Œ  
   get(itemId: TKey): TItem | null {
     if (!itemId) {
       return null;
     }
     const hashValue = itemId.hash();
     if (hashValue === undefined || hashValue === null) {
       return null;
     }
     const key = hashValue.toString();
     return this.itemByIds.get(key) || null;
   }
   ```

#### 2. ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼
1. `DevelopmentTopPage` â†’ `initMasterData()` å‘¼ã³å‡ºã—
2. `initMasterData()` â†’ `router.init.getMasterData.query()` å‘¼ã³å‡ºã—  
3. `initRouter.getMasterData` â†’ `getMasterData()` ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹å‘¼ã³å‡ºã—
4. `getMasterData()` â†’ `iconCategoryRepository.findAllWithIcons()` å‘¼ã³å‡ºã—
5. `IconCategoryRepository.findAllWithIcons()` â†’ å„DAOï¼ˆ`iconCategoryDao`, `iconDao`ç­‰ï¼‰å‘¼ã³å‡ºã—
6. `iconsFactory.fromEntities()` â†’ `iconFactory.fromEntity()` å‘¼ã³å‡ºã—
7. **ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿå¯èƒ½æ€§**: `new IconId(params.entity.id)` ã§`id`ãŒ`undefined`ã®å ´åˆ

#### 3. å…·ä½“çš„ãªå•é¡Œç®‡æ‰€ã¨ä¿®æ­£ãƒ•ãƒ­ãƒ¼

**ã‚·ãƒŠãƒªã‚ªA: BaseCollectionã§ã®ã‚¨ãƒ©ãƒ¼ï¼ˆæœ€æœ‰åŠ›ï¼‰**
1. `IconCategories`ã‚„`Icons`ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ãŒä½œæˆã•ã‚Œã‚‹
2. `updateIndex()`ã¾ãŸã¯`get()`ãƒ¡ã‚½ãƒƒãƒ‰ãŒå‘¼ã°ã‚Œã‚‹
3. `item.key`ãŒ`null`ã§ãªã„å ´åˆã«`item.key.hash().toString()`ãŒå®Ÿè¡Œã•ã‚Œã‚‹
4. **å•é¡Œ**: `hash()`ãƒ¡ã‚½ãƒƒãƒ‰ãŒ`undefined`ã‚’è¿”ã™ã¨`undefined.toString()`ã§ã‚¨ãƒ©ãƒ¼

**ã‚·ãƒŠãƒªã‚ªB: iconFactoryã§ã®ã‚¨ãƒ©ãƒ¼**
**ãƒ•ã‚¡ã‚¤ãƒ«**: `packages/backend/src/features/icon/domain/iconFactory.ts`
```typescript
export const fromEntity = (params: {entity: IconEntity}): Icon => {
  return new Icon({
    id: new IconId(params.entity.id), // â† ã“ã“ã§ entity.id ãŒ undefined ã®å¯èƒ½æ€§
    name: new IconName(params.entity.name),
    sortOrder: new SortOrder(params.entity.sortOrder),
    isActive: params.entity.isActive,
    iconCategoryId: params.entity.categoryId ? new IconCategoryId(params.entity.categoryId) : undefined
  });
}
```

### æ ¹æœ¬åŸå› 
- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®å•é¡Œ**: `IconEntity`ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã§`id`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒ`null`ã¾ãŸã¯æœªè¨­å®š
- **TypeORMã®å•é¡Œ**: ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãƒãƒƒãƒ”ãƒ³ã‚°ã§IDãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ãªã„
- **ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã®å•é¡Œ**: åˆæœŸãƒ‡ãƒ¼ã‚¿ãŒæ­£ã—ãæŠ•å…¥ã•ã‚Œã¦ã„ãªã„å¯èƒ½æ€§

### å¯¾å‡¦æ–¹æ³•ã®ææ¡ˆ

#### å³åº§ã«å¯¾å¿œå¯èƒ½ãªä¿®æ­£
1. **ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å¼·åŒ–**
   ```typescript
   export const fromEntity = (params: {entity: IconEntity}): Icon => {
     if (!params.entity.id) {
       throw new Error(`IconEntity ã®IDãŒä¸æ­£ã§ã™: ${JSON.stringify(params.entity)}`);
     }
     
     return new Icon({
       id: new IconId(params.entity.id),
       // ...
     });
   }
   ```

2. **BaseIdã‚¯ãƒ©ã‚¹ã®é˜²å¾¡çš„ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°**
   ```typescript
   toString(): string {
     if (this._value === undefined || this._value === null) {
       throw new Error(`BaseId ã®å€¤ãŒ undefined ã¾ãŸã¯ null ã§ã™`);
     }
     return this._value.toString();
   }
   ```

#### æ ¹æœ¬çš„ãªä¿®æ­£
1. **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ç¢ºèª**: `icons`ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèª
2. **ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã®å†å®Ÿè¡Œ**: ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã®å†æŠ•å…¥
3. **TypeORMãƒãƒƒãƒ”ãƒ³ã‚°ã®ç¢ºèª**: ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£å®šç¾©ã®æ¤œè¨¼

### èª¿æŸ»ã§ç¢ºèªã—ãŸãƒ•ã‚¡ã‚¤ãƒ«
- `packages/frontend/src/features/auth/services/initMasterData.ts`
- `packages/backend/src/features/auth/router/initRouter.ts`
- `packages/backend/src/features/auth/usecase/getMasterData.ts`
- `packages/backend/src/features/icon-category/repository/iconCategoryRepository.ts`
- `packages/backend/src/features/icon/domain/iconFactory.ts`
- `packages/backend/src/core/value-object/base_id.ts`
- `packages/backend/src/features/icon/entity/iconEntity.ts`

### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®`icons`ãƒ†ãƒ¼ãƒ–ãƒ«ã®çŠ¶æ…‹ç¢ºèª
2. ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®è©³ç´°ç¢ºèªï¼ˆã©ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ã‚‹ã‹ï¼‰
3. é˜²å¾¡çš„ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã«ã‚ˆã‚‹ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–
4. ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã®å†å®Ÿè¡Œ
