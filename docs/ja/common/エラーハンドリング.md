# エラーハンドリング

## 概要
アプリケーションでは階層的なエラーハンドリングを実装しており、エラーの種類に応じて適切な処理を行います。

## エラーハンドリングの階層

### 1. 個別ハンドリング（低レベル）
各ハンドラーや関数で、**既知の**・**予測可能な**エラーを処理します。

#### 対象エラー
- `BaseAppException`: アプリケーション固有の既知エラー
- 認証エラー（Supabase Auth）
- バリデーションエラー
- ネットワークエラー（タイムアウトなど）

#### 実装例
```typescript
try {
  await someOperation();
} catch (error) {
  // 既知のアプリケーションエラー
  if (error instanceof BaseAppException) {
    Alert.alert('エラー', error.localeMessage.getMessage(languageType));
    return;
  }
  
  // 認証関連の既知エラー
  if (error instanceof Error && error.message.includes('auth')) {
    Alert.alert('認証エラー', 'ログイン情報を確認してください');
    return;
  }
  
  // 予期しないエラーは上位に委譲
  throw error;
}
```

### 2. グローバルハンドリング（高レベル）
アプリケーション全体で、**予期しない**・**未処理の**エラーをキャッチします。

#### 実装場所
- `App.tsx`の`ErrorBoundary`
- React コンポーネントの境界でキャッチ

#### 動作
1. 予期しないエラーをキャッチ
2. エラー画面（`ErrorScreen`）を表示
3. ユーザーに再試行オプションを提供
4. エラーログをコンソール・外部サービスに送信

## エラー種別と処理方針

| エラー種別 | 処理レベル | 表示方法 | ユーザー操作 |
|-----------|-----------|---------|------------|
| `BaseAppException` | 個別 | Alert | OK ボタン |
| 認証エラー | 個別 | Alert | ログイン画面へ |
| バリデーションエラー | 個別 | フォーム内表示 | 入力修正 |
| ネットワークエラー | 個別 | Alert | 再試行 |
| 予期しないエラー | グローバル | エラー画面 | 再試行・アプリ再起動 |

## 開発時の注意点

### ✅ 推奨パターン
```typescript
// 既知エラーは個別処理し、未知エラーは上位に委譲
try {
  await operation();
} catch (error) {
  if (error instanceof KnownError) {
    handleKnownError(error);
    return;
  }
  // 予期しないエラーは再throw
  throw error;
}
```

### ❌ 避けるべきパターン
```typescript
// すべてのエラーを握りつぶすのはNG
try {
  await operation();
} catch (error) {
  console.log('エラーが発生しました'); // 何もしない
}

// 不明なエラーを無理やり処理するのもNG
try {
  await operation();
} catch (error) {
  Alert.alert('エラー', '不明なエラーです'); // 詳細不明
}
```

## 実装ファイル

### コンポーネント
- `/src/core/errors/ErrorBoundary.tsx`: エラーバウンダリー
- `/src/core/errors/error-page/ErrorScreen.tsx`: エラー画面
- `/src/core/errors/errorAnalysis.ts`: エラー解析ユーティリティ

### 統合
- `/App.tsx`: グローバルErrorBoundaryの設定（AppInitializerより上位に配置）

### エラー解析機能
新しく追加されたエラー解析機能により、以下の情報が自動的に抽出されます：

#### 取得できる情報
- **エラーファイル名**: エラーが発生したファイルのパス
- **行数・列数**: エラーが発生した正確な位置
- **コンポーネント名**: エラーが発生したReactコンポーネント名
- **スタックトレース**: 詳細なエラー伝播経路

#### 使用例
```typescript
// errorAnalysis.tsの使用
import { analyzeError } from '@/core/errors/errorAnalysis';

const handleError = (error: Error, errorInfo: React.ErrorInfo) => {
  const analysis = analyzeError(error, errorInfo);
  
  console.log('エラー分析結果:', {
    primaryLocation: analysis.analysisInfo.primaryErrorLocation,
    // 例: { component: 'MyComponent', file: '/path/to/MyComponent.tsx', line: '42', column: '15' }
  });
};
```

### エラーバウンダリーの階層化
ErrorBoundaryは以下の階層で配置されています：

```
App (最上位ErrorBoundary)
  └── ThemeProvider
      └── AppInitializer (初期化エラーもキャッチ可能)
          └── AppContent
              └── AppNavigator
```

これにより、AppInitializerでの初期化エラーも含めて、すべてのエラーをキャッチできます。

### 国際化
- `/src/core/i18n/locales/ja.json`: 日本語エラーメッセージ
- `/src/core/i18n/locales/en.json`: 英語エラーメッセージ

### 統合
- `/App.tsx`: グローバルErrorBoundaryの設定

## 今後の拡張

### エラーレポーティング
```typescript
// 外部サービスへの送信例
const handleGlobalError = (error: Error, errorInfo: React.ErrorInfo) => {
  // Sentry、Crashlytics などに送信
  ErrorReportingService.report({
    error,
    errorInfo,
    userInfo: sessionStore.userInfo,
    timestamp: new Date().toISOString(),
  });
};
```

### エラー分類の詳細化
- ネットワーク系エラーの詳細分類
- サーバーエラー（5xx）の専用処理
- 権限エラーの専用画面

### ユーザー体験の向上
- オフライン対応
- 自動リトライ機能
- エラー状況に応じたヘルプ表示
