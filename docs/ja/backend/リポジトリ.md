[indexã¸æˆ»ã‚‹](../index.md)
# ğŸ” ãƒªãƒã‚¸ãƒˆãƒªã‚¯ãƒ©ã‚¹

## æ¦‚è¦
- ãƒªãƒã‚¸ãƒˆãƒªã¯`dao`ã‚’ä½¿ç”¨ã—ã€è¤‡æ•°ã®`entity`ã‹ã‚‰ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ã®ç”Ÿæˆã‚’è¡Œã†
- ãƒ‡ãƒ¼ã‚¿ã®æ°¸ç¶šåŒ–ã¯æ›´ã«ä¸‹ä½å±¤ã®DAOã«å§”è­²ã™ã‚‹
- DAOã‹ã‚‰å–å¾—ã—ãŸã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ã«å¤‰æ›
- è¤‡æ•°ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’çµ„ã¿åˆã‚ã›ã¦ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ã‚’æ§‹ç¯‰
- ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ã‚’ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã«å¤‰æ›ã—ã¦æ°¸ç¶šåŒ–

## ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå›³
```mermaid
classDiagram
    class BaseRepository~IdType, ModelType, EntityType~ {
        #isLatestVersion(model: ModelType, dao: BaseDao~EntityType~): Promise~boolean~
    }
    class XxxRepository {
        constructor(params: XxxRepositoryParams)
        findById(id: XxxId): Promise~XxxModel~
        findAll(): Promise~XxxModel[]~
        save(model: XxxModel): Promise~void~
        delete(model: XxxModel): Promise~void~
    }
    class XxxRepositoryParams {
        xxxDao: XxxDao
        yyyDao: YyyDao
    }
    class BaseModel~IdType, EntityType~ {
        +id: IdType
        +version: Version
        +_validate(): void
        +toEntity(): EntityType
        +isSameVersion(other): boolean
    }

    BaseRepository <|-- XxxRepository
    XxxRepository --> XxxRepositoryParams : ä¾å­˜
    XxxRepository --> BaseModel: ä½¿ç”¨
    XxxRepository --> dao: æ°¸ç¶šåŒ–
```

## `BaseRepository<IdType, ModelType, EntityType>`ã‚¯ãƒ©ã‚¹
### æ¦‚è¦
- ãƒªãƒã‚¸ãƒˆãƒªã®åŸºåº•ã‚¯ãƒ©ã‚¹
- 3ã¤ã®ã‚¸ã‚§ãƒãƒªã‚¯ã‚¹å‹ã‚’å—ã‘å–ã‚‹
  - `IdType`: BaseIdã‚’ç¶™æ‰¿ã—ãŸIDå€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
  - `ModelType`: BaseModelã‚’ç¶™æ‰¿ã—ãŸãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«
  - `EntityType`: AppBaseEntityã‚’ç¶™æ‰¿ã—ãŸã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
  - ä¾‹: `class XxxRepository extends BaseRepository<XxxId, XxxModel, XxxEntity> {}`

- å„ãƒªãƒã‚¸ãƒˆãƒªã§ä½¿ç”¨ã™ã‚‹å…±é€šã®å…·è±¡ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æä¾›ã™ã‚‹
  - ãŸã ã—ã€findã‚„saveãªã©ã®ãƒ¡ã‚½ãƒƒãƒ‰ã¯å®šç¾©ã›ãšã€å¿…è¦ãªã¨ãã«å®Ÿè£…å´ã§å®šç¾©ã™ã‚‹

- è¤‡æ•°ã®DAOã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ã¨ãã¯ã€éåŒæœŸã§å®Ÿè¡Œã™ã‚‹ã“ã¨
- ä¾‹:
```typescript
async findAll(): Promise<XxxModel[]> {
    const [xxxEntities, yyyEntities] = await Promise.all([
        this.xxxDao.fetchAll(),
        this.yyyDao.fetchAll()
    ]);
    
    // ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‹ã‚‰ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ã«å¤‰æ›
    return this.convertToModels(xxxEntities, yyyEntities);
}
```

### é…ç½®å ´æ‰€
- `core/repository/baseRepository.ts`

## `XxxRepository`ã‚¯ãƒ©ã‚¹
### æ¦‚è¦
- ä¸€ã¤ã®ãƒ¢ãƒ‡ãƒ«ã«å¯¾ã—ã¦ä¸€ã¤ã®ãƒªãƒã‚¸ãƒˆãƒªã‚’ä½œæˆ
  - `QuestModel`ã«å¯¾ã—ã¦`QuestRepository`ã‚’ä½œæˆ

- å¿…è¦ã«å¿œã˜ã¦ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè£…ã™ã‚‹
  - `findById(id: number): Promise<XxxModel>`
    - IDã§ãƒ¢ãƒ‡ãƒ«ã‚’æ¤œç´¢
  - `findAll(): Promise<XxxModel[]>`
    - å…¨ã¦ã®ãƒ¢ãƒ‡ãƒ«ã‚’å–å¾—
  - `save(model: XxxModel): Promise<void>`
    - ãƒ¢ãƒ‡ãƒ«ã‚’æ°¸ç¶šåŒ–
  - `delete(model: XxxModel): Promise<void>`
    - ãƒ¢ãƒ‡ãƒ«ã‚’å‰Šé™¤

### é…ç½®å ´æ‰€
- `features/{é–¢å¿ƒäº‹å}/repository/{é–¢å¿ƒäº‹å}Repository.ts`

### å‘½åè¦å‰‡
- ãƒªãƒã‚¸ãƒˆãƒªåã¯`{é–¢å¿ƒäº‹å}Repository`ã¨ã™ã‚‹
  - ä¾‹: `QuestRepository`, `FamilyMemberRepository`

- `Params`ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åã¯`params`ã¨ã™ã‚‹
  - ä¾‹: `params: QuestRepositoryParams`

### å®Ÿè£…ä¾‹
```typescript
import { BaseRepository } from '../../core/repository/baseRepository';
import { QuestModel } from '../domain/questModel';
import { QuestDao } from '../dao/questDao';
import { QuestEntity } from '../entity/questEntity';
import { QuestId } from '../domain/value-object/questId';

export interface QuestRepositoryParams {
  questDao: QuestDao;
  // ãã®ä»–å¿…è¦ãªDAO
}

export class QuestRepository extends BaseRepository<QuestId, QuestModel, QuestEntity> {
  private questDao: QuestDao;

  constructor(params: QuestRepositoryParams) {
    super();
    this.questDao = params.questDao;
  }

  async findById(id: QuestId): Promise<QuestModel | null> {
    const entity = await this.questDao.fetchById(id.toNumber());
    if (!entity) {
      return null;
    }
    return QuestModel.fromEntity(entity);
  }

  async findAll(): Promise<QuestModel[]> {
    const entities = await this.questDao.fetchAll();
    return entities.map(entity => QuestModel.fromEntity(entity));
  }

  async save(model: QuestModel): Promise<void> {
    // æ¥½è¦³çš„ãƒ­ãƒƒã‚¯ç¢ºèªï¼ˆæ›´æ–°ã®å ´åˆï¼‰
    if (model.id.toNumber() > 0) {
      const isLatest = await this.isLatestVersion(model, this.questDao);
      if (!isLatest) {
        throw new Error('ãƒ‡ãƒ¼ã‚¿ãŒä»–ã®ãƒ¦ãƒ¼ã‚¶ã«ã‚ˆã£ã¦æ›´æ–°ã•ã‚Œã¦ã„ã¾ã™ã€‚');
      }
    }

    const entity = model.toEntity();
    
    if (model.id.toNumber() > 0) {
      await this.questDao.update(entity);
    } else {
      const newId = await this.questDao.insert(entity);
      // æ–°ã—ã„IDã§ãƒ¢ãƒ‡ãƒ«ã‚’å†ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã‹ã‚‚
    }
  }

  async delete(model: QuestModel): Promise<void> {
    const modelId = model.id.toNumber();
    if (modelId <= 0) {
      throw new Error('å‰Šé™¤å¯¾è±¡ã®IDãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
    }

    // æ¥½è¦³çš„ãƒ­ãƒƒã‚¯ç¢ºèª
    const isLatest = await this.isLatestVersion(model, this.questDao);
    if (!isLatest) {
      throw new Error('ãƒ‡ãƒ¼ã‚¿ãŒä»–ã®ãƒ¦ãƒ¼ã‚¶ã«ã‚ˆã£ã¦æ›´æ–°ã•ã‚Œã¦ã„ã¾ã™ã€‚');
    }

    await this.questDao.delete(modelId);
  }
}
```

## `XxxRepositoryParams`ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
### æ¦‚è¦
- ãƒªãƒã‚¸ãƒˆãƒªãŒä¾å­˜ã™ã‚‹DAOã‚’ä¿æŒã™ã‚‹ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
- ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã§å—ã‘å–ã‚Šã€ä¾å­˜æ€§æ³¨å…¥ã‚’è¡Œã†
  - paramsè‡ªä½“ã‚’fieldã«ä¿æŒã™ã‚‹ã®ã§ã¯ãªãã€å¿…è¦ãªDAOã‚’å€‹åˆ¥ã«ä¿æŒã™ã‚‹
- DAOã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä¿æŒã—ã€ãƒªãƒã‚¸ãƒˆãƒªå†…ã§ä½¿ç”¨ã™ã‚‹

### é…ç½®å ´æ‰€
- ãƒªãƒã‚¸ãƒˆãƒªã¨åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã«é…ç½®ã™ã‚‹ã“ã¨
- ãƒªãƒã‚¸ãƒˆãƒªã‚¯ãƒ©ã‚¹ã®ç›´å‰ã«é…ç½®ã™ã‚‹ã“ã¨

### å‘½åè¦å‰‡
- ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹åã¯`{é–¢å¿ƒäº‹å}RepositoryParams`ã¨ã™ã‚‹
  - ä¾‹: `QuestRepositoryParams`, `FamilyMemberRepositoryParams`

### å®Ÿè£…ä¾‹
```typescript
export interface QuestRepositoryParams {
  questDao: QuestDao;
  categoryDao: CategoryDao;
  // ãã®ä»–å¿…è¦ãªDAO
}
```
